###############################################################################
# GenieACS – serviços principais                                              #
###############################################################################
services:
  genieacs:
    image: drumsergio/genieacs:latest
    container_name: genieacs
    restart: always
    depends_on:
      - mongo
    environment:
      GENIEACS_UI_JWT_SECRET: changeme
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://mongo/genieacs?authSource=admin
      DEBUG: "cwmp:*"
    ports:
      - "7547:7547"   # CWMP – onde os CPEs se conectam
      - "7557:7557"   # NBI  – REST API usada pelo backend
      - "7567:7567"   # File-Server (firmware, etc.)
      - "3000:3000"   # Interface Web
    networks:
      - genieacs_net

  mongo:
    image: mongo:8.0
    container_name: mongo-genieacs
    restart: always
    volumes:
      - data_db:/data/db
      - data_configdb:/data/configdb
    expose:
      - "27017"
    networks:
      - genieacs_net

  #############################################################################
  # Simulador CPE – 5 roteadores no mesmo contêiner                           #
  #############################################################################
  genieacs-sim:
    image: drumsergio/genieacs-sim:latest
    container_name: genieacs-sim
    depends_on:
      - genieacs
    command: >-
      genieacs-sim --processes 5 --serial 100 --acs-url http://genieacs:7547
    restart: always          # (sugestão: 'always' para não “sumir” ao reiniciar)
    networks:
      - genieacs_net

  genieacs-mcp:
    image: drumsergio/genieacs-mcp:latest
    container_name: genieacs-mcp
    depends_on:
      - genieacs
    environment:
      ACS_URL:  http://genieacs:7557
      ACS_USER: admin
      ACS_PASS: admin
    ports:
      - "8080:8080"
    networks:
      - genieacs_net

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.backend
    container_name: genieacs-backend
    restart: always
    depends_on:
      - genieacs
    environment:
      GENIEACS_NBI_URL: http://genieacs:7557
      ACS_API_KEY_FILE: /run/secrets/genieacs_api_key
      FRONTEND_ORIGINS: http://localhost:1234,http://127.0.0.1:1234
    secrets:
      - genieacs_api_key
    ports:
      - "8000:8000"
    networks:
      - genieacs_net
    volumes:
      - ./backend/genieacs_backend_mvp.py:/app/genieacs_backend_mvp.py:ro

###############################################################################
# Volumes e rede                                                              #
###############################################################################
volumes:
  data_db:
  data_configdb:

networks:
  genieacs_net:
    driver: bridge

secrets:
  genieacs_api_key:
    file: ./secrets/genieacs_api_key.txt
